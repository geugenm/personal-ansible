name: Ansible Syntax Check

on:
  push:
    paths:
      - "roles/**/*.yml"
      - "playbooks/**/*.yml"
      - "inventory/**/*.yml"
      - ".github/workflows/**/*.yml"
  pull_request:
    paths:
      - "roles/**/*.yml"
      - "playbooks/**/*.yml"
      - "inventory/**/*.yml"
      - ".github/workflows/**/*.yml"

jobs:
  syntax-check:
    name: Ansible Syntax Check (Linux)
    runs-on: fedora-latest
    container: cytopia/ansible:latest-tools

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate infrastructure
        shell: sh
        run: |
          set -eo pipefail
          find playbooks -type f -name '*.yml' | xargs -tI{} ansible-playbook --syntax-check {}
          ansible-inventory --graph -i inventory/hosts.yml
          ansible-playbook -i inventory/hosts.yml playbooks/site.yml --check
